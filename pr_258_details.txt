title:	Добавить брызги крови на полу и стенах (issue #257)
state:	DRAFT
author:	konard
labels:	
assignees:	
reviewers:	
projects:	
milestone:	
number:	258
url:	https://github.com/Jhon-Crow/godot-topdown-MVP/pull/258
additions:	5275
deletions:	13
auto-merge:	disabled
--
## Summary

Adds blood splatter effects on floor and walls when bullets hit characters (not hitting armor/when non-lethal hit sound plays).

### Changes

- **Floor blood decals now spawn on ALL hits** (not just lethal ones)
  - Lethal hits: Full-size blood decals
  - Non-lethal hits: Smaller decals (50% scale)
  - Position offset based on bullet direction as requested

- **Wall blood splatters** are now spawned when walls are nearby
  - Uses raycasting to detect walls within 100px in bullet direction
  - Elongated splatter shape on walls (taller than wide)
  - Scale based on distance - closer walls get more blood
  - Lethal hits produce 30% more blood on walls
  - Non-lethal hits produce 40% less blood on walls

### Bug Fixes (Investigation from User Feedback)

- **Fixed WALL_COLLISION_LAYER**: Changed from `1` (player layer) to `4` (obstacles layer 3 bitmask)
  - The original implementation incorrectly targeted the player collision layer instead of the obstacles layer
  - Layer mapping: 1=player(1), 2=enemies(2), 3=obstacles(4), 4=pickups(8), etc.

- **Fixed GPUParticles2D compatibility issue**: Changed all effect scenes to use Particles2D instead of GPUParticles2D
  - GPUParticles2D does not work in gl_compatibility rendering mode
  - Updated BloodEffect, DustEffect, and SparksEffect scenes
  - Updated ImpactEffectsManager casting to Particles2D
  - This resolves the autoload failing to load silently

- **Fixed effect_cleanup.gd script**: Changed from extending GPUParticles2D to Particles2D
  - The effect_cleanup.gd script was still extending GPUParticles2D while scenes used Particles2D
  - This mismatch prevented the ImpactEffectsManager autoload from loading properly
  - Root cause of blood effects not appearing in-game

- **Added diagnostic logging via FileLogger**
  - Now logs when ImpactEffectsManager is initialized and scenes are loaded
  - Logs when `spawn_blood_effect()` is called with position and lethal status
  - Logs when blood decals are spawned with position and total count
  - Logs when wall blood splatters are detected and spawned

### Technical Details

- Modified `ImpactEffectsManager.spawn_blood_effect()` to always spawn floor decals
- Added `_spawn_wall_blood_splatter()` method for wall detection and splatter spawning
- Added constants: `WALL_SPLATTER_CHECK_DISTANCE` (100px) and `WALL_COLLISION_LAYER` (4)
- Uses existing `BloodDecal.tscn` scene for both floor and wall splatters
- Wall splatters have higher z-index (0) than floor decals (-1) for proper rendering
- Added FileLogger integration for runtime diagnostics

### Test Plan

- [x] Added unit tests for new wall splatter functionality
- [x] Added unit test for correct wall collision layer bitmask value
- [x] Tests verify constants and method existence
- [x] Tests verify non-lethal hits now spawn floor decals
- [ ] Manual testing: Shoot enemies near walls to verify wall splatters appear
- [ ] Manual testing: Verify floor decals appear on both lethal and non-lethal hits

### Case Study

Full investigation analysis is documented in `docs/case-studies/issue-257/analysis.md`

### References

- Reddit reference from issue: [Blood effect using render textures](https://www.reddit.com/r/godot/comments/ffvamw/made_a_blood_effect_using_render_textures_as_a/?tl=ru)
- [Godot Issue #84072](https://github.com/godotengine/godot/issues/84072) - GPU Particles in compatibility mode
- [Godot Issue #85945](https://github.com/godotengine/godot/issues/85945) - GPUParticles2D in compatibility mode

---
Fixes #257
