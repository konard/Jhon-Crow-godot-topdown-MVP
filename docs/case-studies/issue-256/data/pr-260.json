{"additions":1308,"author":{"id":"MDQ6VXNlcjE0MzE5MDQ=","is_bot":false,"login":"konard","name":"Konstantin Diachenko"},"body":"## Summary\n\nThis PR changes the grenade throwing system to use realistic velocity-based physics instead of drag distance. The key change is that throw velocity is now determined by **mouse velocity at the moment of release**, not by how far the mouse was dragged from the starting position.\n\n### Root Cause Found (Update 2026-01-22)\n\nThe original GDScript implementation was correct, but **the game uses the C# Player.cs code path**. The C# code was still calling the legacy `throw_grenade()` method with drag distance. This commit adds velocity-based throwing to Player.cs to sync with player.gd.\n\n### Physics Model\n\n- **Mouse velocity at release** â†’ determines grenade's initial velocity\n- **Grenade mass** â†’ heavier grenades are harder to throw far with same mouse speed\n- **Swing distance** â†’ longer mouse movement distance = better momentum transfer\n- **No movement at release** â†’ grenade drops at player's feet\n\n### Key Formula\n\n```\nthrow_velocity = (mouse_velocity Ã— multiplier Ã— transfer_efficiency) / âˆš(mass_ratio)\ntransfer_efficiency = clamp(swing_distance / (min_swing_distance Ã— mass_ratio), 0, 1)\n```\n\n### Changes\n\n**GDScript (player.gd + grenade_base.gd):**\n- `grenade_base.gd`: Added `throw_grenade_velocity_based()` method with mass-based physics\n- `grenade_base.gd`: Added new properties: `grenade_mass`, `mouse_velocity_to_throw_multiplier`, `min_swing_distance`\n- `player.gd`: Implemented mouse velocity tracking with history smoothing (last 5 frames)\n- `player.gd`: Updated `_throw_grenade()` to use velocity-based physics\n\n**C# (Player.cs) - NEW in this update:**\n- Added mouse velocity tracking fields (`_mouseVelocityHistory`, `_currentMouseVelocity`, `_totalSwingDistance`)\n- Updated `ThrowGrenade()` to call `throw_grenade_velocity_based()` with mouse velocity\n- Updated `UpdateWindUpIntensity()` for velocity-based tracking\n- Updated debug trajectory visualization for velocity-based predictions\n- Added startup log: `[Player.Grenade] Throwing system: VELOCITY-BASED (v2.0)`\n\n**Scene files:**\n- `FlashbangGrenade.tscn`: Configured mass=0.36kg (lighter, easier to throw)\n- `FragGrenade.tscn`: Configured mass=0.45kg (heavier, needs more momentum)\n\n**Tests:**\n- `test_grenade_base.gd`: Added 12 comprehensive tests for velocity-based throwing\n\n## Test Plan\n\n- [ ] Rebuild the Godot project (including C# rebuild)\n- [ ] Verify startup log shows: `[Player.Grenade] Throwing system: VELOCITY-BASED (v2.0)`\n- [ ] Test throw with mouse STOPPED at release â†’ grenade should drop at feet\n- [ ] Test throw with FAST mouse movement at release â†’ grenade should fly far\n- [ ] Test flashbang throw with medium speed â†’ medium distance\n- [ ] Test frag grenade requires more swing distance than flashbang (heavier)\n- [ ] Verify debug trajectory (F7) updates based on mouse velocity\n- [ ] Verify existing grenade functionality (timer, explosion, effects) still works\n\nResolves #256\n\nðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)","commits":[{"authoredDate":"2026-01-22T16:40:41Z","authors":[{"email":"drakonard@gmail.com","id":"MDQ6VXNlcjE0MzE5MDQ=","login":"konard","name":"konard"}],"committedDate":"2026-01-22T16:40:41Z","messageBody":"Adding CLAUDE.md with task information for AI processing.\nThis file will be removed when the task is complete.\n\nIssue: https://github.com/Jhon-Crow/godot-topdown-MVP/issues/256","messageHeadline":"Initial commit with task details","oid":"7d62df43af7f87278d800dc50c292af098707547"},{"authoredDate":"2026-01-22T16:46:27Z","authors":[{"email":"drakonard@gmail.com","id":"MDQ6VXNlcjE0MzE5MDQ=","login":"konard","name":"konard"},{"email":"noreply@anthropic.com","id":"MDQ6VXNlcjgxODQ3","login":"claude","name":"Claude Opus 4.5"}],"committedDate":"2026-01-22T16:46:27Z","messageBody":"This changes the grenade throwing system to use mouse velocity at the\nmoment of release instead of drag distance. The new system models\nrealistic physics where:\n\n- Throw velocity is based on mouse velocity at release, not distance\n- If mouse is stationary at release, grenade drops at player's feet\n- Grenade mass affects velocity transfer efficiency (heavier = harder)\n- Swing distance affects momentum transfer (longer swing = better transfer)\n\nKey changes:\n- Add throw_grenade_velocity_based() method to GrenadeBase\n- Add grenade_mass, mouse_velocity_to_throw_multiplier, min_swing_distance\n- Track mouse velocity history in player.gd for smooth velocity calc\n- Update _throw_grenade to use velocity-based physics\n- Add comprehensive tests for new throwing mechanics\n- Configure mass values for Flashbang (0.36kg) and Frag (0.45kg)\n\nResolves: #256\n\nCo-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>","messageHeadline":"Implement realistic velocity-based grenade throwing physics","oid":"e39784b261c81eb507b5a9a2c1336ad0c78910cc"},{"authoredDate":"2026-01-22T16:48:31Z","authors":[{"email":"drakonard@gmail.com","id":"MDQ6VXNlcjE0MzE5MDQ=","login":"konard","name":"konard"}],"committedDate":"2026-01-22T16:48:31Z","messageBody":"This reverts commit 7d62df43af7f87278d800dc50c292af098707547.","messageHeadline":"Revert \"Initial commit with task details\"","oid":"0df23ecb6626a3c684d474f2a0e113843b89feef"},{"authoredDate":"2026-01-22T17:53:46Z","authors":[{"email":"drakonard@gmail.com","id":"MDQ6VXNlcjE0MzE5MDQ=","login":"konard","name":"konard"},{"email":"noreply@anthropic.com","id":"MDQ6VXNlcjgxODQ3","login":"claude","name":"Claude Opus 4.5"}],"committedDate":"2026-01-22T17:53:46Z","messageBody":"- Add docs/case-studies/issue-256/ with detailed analysis of why the\n  velocity-based physics changes appeared not to be applied (root cause:\n  old game build that predates the changes)\n- Add startup log to player.gd showing which throwing system is active:\n  \"[Player.Grenade] Throwing system: VELOCITY-BASED (v2.0)\"\n- Add warning log when legacy throw_grenade() is called instead of\n  throw_grenade_velocity_based() to help diagnose version mismatches\n- Include original game logs from user testing for reference\n\nThis makes it immediately clear in logs which throwing system version\nis running, helping diagnose cases where builds may not be updated.\n\nResolves feedback from PR #260\n\nCo-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>","messageHeadline":"Add case study and enhanced debug logging for grenade throwing system","oid":"3288d5a958f4349f85b8137666847cfe9b2da91b"},{"authoredDate":"2026-01-22T20:21:02Z","authors":[{"email":"drakonard@gmail.com","id":"MDQ6VXNlcjE0MzE5MDQ=","login":"konard","name":"konard"},{"email":"noreply@anthropic.com","id":"MDQ6VXNlcjgxODQ3","login":"claude","name":"Claude Opus 4.5"}],"committedDate":"2026-01-22T20:21:02Z","messageBody":"Root cause: The C# Player.cs was still using legacy drag-based throwing\nwhile only the GDScript player.gd was updated. The game uses the C# code\npath, so velocity-based physics were never applied.\n\nChanges to Scripts/Characters/Player.cs:\n- Add mouse velocity tracking with 5-sample history for smooth velocity\n- Add total swing distance tracking for momentum transfer calculation\n- Update ThrowGrenade() to use throw_grenade_velocity_based() method\n- Update UpdateWindUpIntensity() for velocity-based wind-up animation\n- Update debug trajectory visualization for velocity-based predictions\n- Add startup log showing which throwing system is active\n\nKey behavior change:\n- Mouse VELOCITY at release determines throw power (not drag distance)\n- If mouse is stopped at release, grenade drops at player's feet\n- Faster mouse movement = farther throw\n- Swing distance affects momentum transfer efficiency\n\nThis syncs the C# implementation with the GDScript velocity-based system.\n\nResolves issue #256 feedback: \"even if mouse is completely stopped,\ngrenade still flies far (should stay in place)\"\n\nCo-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>","messageHeadline":"Implement velocity-based grenade throwing in Player.cs (C#)","oid":"ccc03e6b0f1826f03f9ec856edac69d9529cc182"}],"createdAt":"2026-01-22T16:40:48Z","deletions":126,"files":[{"path":"Scripts/Characters/Player.cs","additions":151,"deletions":77},{"path":"docs/case-studies/issue-256/case-study.md","additions":124,"deletions":0},{"path":"docs/case-studies/issue-256/game_log_20260122_195917.txt","additions":81,"deletions":0},{"path":"docs/case-studies/issue-256/game_log_20260122_195927.txt","additions":223,"deletions":0},{"path":"docs/case-studies/issue-256/game_log_20260122_210703.txt","additions":434,"deletions":0},{"path":"scenes/projectiles/FlashbangGrenade.tscn","additions":3,"deletions":0},{"path":"scenes/projectiles/FragGrenade.tscn","additions":3,"deletions":0},{"path":"scripts/characters/player.gd","additions":90,"deletions":45},{"path":"scripts/projectiles/grenade_base.gd","additions":57,"deletions":3},{"path":"tests/unit/test_grenade_base.gd","additions":142,"deletions":1}],"mergeStateStatus":"CLEAN","state":"OPEN","title":"Implement realistic velocity-based grenade throwing physics","updatedAt":"2026-01-23T19:04:38Z"}
